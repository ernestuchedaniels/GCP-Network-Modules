name: Terraform GitOps Pipeline

on:
  workflow_dispatch:  # Manual trigger for testing
  push:
    branches: [main]
    paths:
      - 'dev-root/**'
      - 'prod-root/**'
  pull_request:
    branches: [main]
    paths:
      - 'dev-root/**'
      - 'prod-root/**'

env:
  TF_CLOUD_ORGANIZATION: "Visa-replica"
  TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-workspaces: ${{ steps.changes.outputs.workspaces }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed workspaces
        id: changes
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi
          
          # Extract workspace names from changed paths
          WORKSPACES=$(echo "$CHANGED_FILES" | grep -E '^(dev|prod)-root/' | cut -d'/' -f1-2 | sort -u | while read path; do
            if [ -n "$path" ]; then
              env=$(echo $path | cut -d'-' -f1)
              stage=$(echo $path | cut -d'/' -f2)
              echo "${env}-${stage}"
            fi
          done | jq -R -s -c 'split("\n")[:-1]')
          
          echo "workspaces=$WORKSPACES" >> $GITHUB_OUTPUT
          echo "Changed workspaces: $WORKSPACES"



  speculative-plan:
    needs: [detect-changes]
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.changed-workspaces != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: ${{ fromJson(needs.detect-changes.outputs.changed-workspaces) }}
    steps:
      - uses: actions/checkout@v4
      - name: Trigger Speculative Plan
        id: trigger-plan
        run: |
          # Get workspace ID
          WORKSPACE_ID=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            "https://app.terraform.io/api/v2/organizations/Visa-replica/workspaces/${{ matrix.workspace }}" | \
            jq -r '.data.id')
          
          # Create configuration version from current branch
          CONFIG_VERSION_RESPONSE=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            --request POST \
            --data "{
              \"data\": {
                \"type\": \"configuration-versions\",
                \"attributes\": {
                  \"auto-queue-runs\": false,
                  \"speculative\": true
                },
                \"relationships\": {
                  \"workspace\": {
                    \"data\": {
                      \"type\": \"workspaces\",
                      \"id\": \"$WORKSPACE_ID\"
                    }
                  }
                }
              }
            }" \
            "https://app.terraform.io/api/v2/workspaces/$WORKSPACE_ID/configuration-versions")
          
          CONFIG_VERSION_ID=$(echo "$CONFIG_VERSION_RESPONSE" | jq -r '.data.id')
          UPLOAD_URL=$(echo "$CONFIG_VERSION_RESPONSE" | jq -r '.data.attributes."upload-url"')
          
          # Create tar.gz of current workspace directory
          # Convert workspace name to directory path (dev-02-networking-core -> dev-root/02-networking-core)
          ENV=$(echo "${{ matrix.workspace }}" | cut -d'-' -f1)
          STAGE=$(echo "${{ matrix.workspace }}" | cut -d'-' -f2-)
          WORKSPACE_DIR="${ENV}-root/${STAGE}"
          
          tar -czf config.tar.gz -C "$WORKSPACE_DIR" .
          
          # Upload configuration
          curl -X PUT "$UPLOAD_URL" --data-binary @config.tar.gz
          
          # Trigger speculative plan with feature branch config
          RUN_RESPONSE=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            --request POST \
            --data "{
              \"data\": {
                \"attributes\": {
                  \"is-destroy\": false,
                  \"message\": \"Speculative plan for PR #${{ github.event.number }} from ${{ github.head_ref }}\"
                },
                \"type\": \"runs\",
                \"relationships\": {
                  \"workspace\": {
                    \"data\": {
                      \"type\": \"workspaces\",
                      \"id\": \"$WORKSPACE_ID\"
                    }
                  },
                  \"configuration-version\": {
                    \"data\": {
                      \"type\": \"configuration-versions\",
                      \"id\": \"$CONFIG_VERSION_ID\"
                    }
                  }
                }
              }
            }" \
            https://app.terraform.io/api/v2/runs)
          
          RUN_ID=$(echo "$RUN_RESPONSE" | jq -r '.data.id')
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "workspace_id=$WORKSPACE_ID" >> $GITHUB_OUTPUT
          echo "Triggered run: $RUN_ID with feature branch config"

      - name: Wait for Plan and Get Results
        run: |
          RUN_ID="${{ steps.trigger-plan.outputs.run_id }}"
          
          # Wait for plan to complete (max 5 minutes)
          for i in {1..30}; do
            RUN_RESPONSE=$(curl -s \
              --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
              --header "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2/runs/$RUN_ID")
            
            RUN_STATUS=$(echo "$RUN_RESPONSE" | jq -r '.data.attributes.status')
            echo "Run status: $RUN_STATUS"
            
            if [[ "$RUN_STATUS" == "planned" || "$RUN_STATUS" == "errored" || "$RUN_STATUS" == "canceled" ]]; then
              break
            fi
            
            sleep 10
          done
          
          # Get plan details and full output
          PLAN_ID=$(echo "$RUN_RESPONSE" | jq -r '.data.relationships.plan.data.id // "null"')
          
          echo "## Terraform Plan for \`${{ matrix.workspace }}\`" >> plan_output.md
          echo "" >> plan_output.md
          echo "**Status:** $RUN_STATUS" >> plan_output.md
          echo "" >> plan_output.md
          
          if [ "$PLAN_ID" != "null" ] && [ "$RUN_STATUS" == "planned" ]; then
            # Get plan logs URL
            PLAN_DETAILS=$(curl -s \
              --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
              --header "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2/plans/$PLAN_ID")
            
            PLAN_LOG_URL=$(echo "$PLAN_DETAILS" | jq -r '.data.attributes."log-read-url"')
            
            if [ "$PLAN_LOG_URL" != "null" ]; then
              # Fetch the full plan output
              PLAN_OUTPUT=$(curl -s "$PLAN_LOG_URL")
              
              echo "\`\`\`terraform" >> plan_output.md
              echo "$PLAN_OUTPUT" >> plan_output.md
              echo "\`\`\`" >> plan_output.md
            else
              echo "Plan output not available" >> plan_output.md
            fi
          else
            echo "No plan available (status: $RUN_STATUS)" >> plan_output.md
          fi
          
          echo "" >> plan_output.md
          echo "ðŸ”— [View in TFE](https://app.terraform.io/app/Visa-replica/workspaces/${{ matrix.workspace }}/runs)" >> plan_output.md

      - name: Display Plan Results
        run: |
          if [ -f "plan_output.md" ]; then
            echo "=== TERRAFORM PLAN OUTPUT ==="
            cat plan_output.md
            echo "============================="
          else
            echo "No plan output available"
          fi

  apply-on-merge:
    needs: [detect-changes]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.detect-changes.outputs.changed-workspaces != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workspace: ${{ fromJson(needs.detect-changes.outputs.changed-workspaces) }}
    steps:
      - uses: actions/checkout@v4
      - name: Trigger Apply Run
        run: |
          # Get workspace ID
          WORKSPACE_ID=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            "https://app.terraform.io/api/v2/organizations/Visa-replica/workspaces/${{ matrix.workspace }}" | \
            jq -r '.data.id')
          
          # Create configuration version for main branch
          CONFIG_VERSION_RESPONSE=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            --request POST \
            --data "{
              \"data\": {
                \"type\": \"configuration-versions\",
                \"attributes\": {
                  \"auto-queue-runs\": false
                },
                \"relationships\": {
                  \"workspace\": {
                    \"data\": {
                      \"type\": \"workspaces\",
                      \"id\": \"$WORKSPACE_ID\"
                    }
                  }
                }
              }
            }" \
            "https://app.terraform.io/api/v2/workspaces/$WORKSPACE_ID/configuration-versions")
          
          CONFIG_VERSION_ID=$(echo "$CONFIG_VERSION_RESPONSE" | jq -r '.data.id')
          UPLOAD_URL=$(echo "$CONFIG_VERSION_RESPONSE" | jq -r '.data.attributes."upload-url"')
          
          # Create tar.gz of main branch workspace directory
          ENV=$(echo "${{ matrix.workspace }}" | cut -d'-' -f1)
          STAGE=$(echo "${{ matrix.workspace }}" | cut -d'-' -f2-)
          WORKSPACE_DIR="${ENV}-root/${STAGE}"
          
          tar -czf config.tar.gz -C "$WORKSPACE_DIR" .
          
          # Upload configuration
          curl -X PUT "$UPLOAD_URL" --data-binary @config.tar.gz
          
          # Trigger apply run
          curl \
            --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            --request POST \
            --data "{
              \"data\": {
                \"attributes\": {
                  \"is-destroy\": false,
                  \"message\": \"Apply run triggered by merge to main - ${{ github.sha }}\"
                },
                \"type\": \"runs\",
                \"relationships\": {
                  \"workspace\": {
                    \"data\": {
                      \"type\": \"workspaces\",
                      \"id\": \"$WORKSPACE_ID\"
                    }
                  },
                  \"configuration-version\": {
                    \"data\": {
                      \"type\": \"configuration-versions\",
                      \"id\": \"$CONFIG_VERSION_ID\"
                    }
                  }
                }
              }
            }" \
            https://app.terraform.io/api/v2/runs: {
                  \"is-destroy\": false,
                  \"message\": \"Apply run triggered by merge to main - ${{ github.sha }}\"
                },
                \"type\": \"runs\",
                \"relationships\": {
                  \"workspace\": {
                    \"data\": {
                      \"type\": \"workspaces\",
                      \"id\": \"$WORKSPACE_ID\"
                    }
                  }
                }
              }
            }" \
            https://app.terraform.io/api/v2/runs